image: gitpod/workspace-python:latest

tasks:
  - name: Setup VLIMF Research Environment
    init: |
      echo "=== Setting up VLIMF Research Environment ==="
      
      # Update system
      sudo apt-get update
      
      # Install Terraform
      echo "Installing Terraform..."
      wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      sudo apt-get update && sudo apt-get install terraform
      
      # Install Crossplane CLI
      echo "Installing Crossplane CLI..."
      curl -sL https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh | sh
      sudo mv kubectl-crossplane /usr/local/bin/
      
      # Install AWS CLI
      echo "Installing AWS CLI..."
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      unzip awscliv2.zip
      sudo ./aws/install
      
      # Install Alibaba Cloud CLI
      echo "Installing Alibaba Cloud CLI..."
      curl -sL https://aliyuncli.alibabacloud.com/install.sh | bash
      
      # Install kubectl
      echo "Installing kubectl..."
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      
      # Install Docker
      echo "Installing Docker..."
      curl -fsSL https://get.docker.com -o get-docker.sh
      sudo sh get-docker.sh
      
      # Install Python dependencies
      echo "Installing Python packages..."
      pip install apache-libcloud tencentcloud-sdk-python boto3 pandas numpy matplotlib
      
      # Create project structure
      echo "Creating project structure..."
      mkdir -p {src,configs,experiments,docs}
      mkdir -p src/{terraform,crossplane,libcloud,evaluation}
      
      # Create welcome script
      cat > welcome.sh << 'EOF'
      #!/bin/bash
      echo "=============================================="
      echo "VLIMF Research Environment Ready!"
      echo "=============================================="
      echo ""
      echo "Available Tools:"
      echo "• Terraform: $(terraform version | head -n1)"
      echo "• Crossplane: installed"
      echo "• AWS CLI: $(aws --version 2>/dev/null || echo 'installed')"
      echo "• kubectl: $(kubectl version --client -o json 2>/dev/null | jq -r '.clientVersion.gitVersion' || echo 'installed')"
      echo "• Docker: $(docker --version)"
      echo ""
      echo "Next Steps:"
      echo "1. Configure cloud credentials in Gitpod Settings"
      echo "2. Run: ./setup-clouds.sh"
      echo "3. Begin your research!"
      echo "=============================================="
      EOF
      chmod +x welcome.sh
      
      # Create cloud setup script
      cat > setup-clouds.sh << 'EOF'
      #!/bin/bash
      echo "=== Cloud Provider Setup ==="
      echo ""
      echo "To configure cloud providers, set these environment variables in Gitpod:"
      echo ""
      echo "1. AWS:"
      echo "   AWS_ACCESS_KEY_ID"
      echo "   AWS_SECRET_ACCESS_KEY"
      echo "   AWS_DEFAULT_REGION=us-east-1"
      echo ""
      echo "2. Alibaba Cloud:"
      echo "   ALICLOUD_ACCESS_KEY"
      echo "   ALICLOUD_SECRET_KEY"
      echo "   ALICLOUD_REGION=cn-hangzhou"
      echo ""
      echo "3. Tencent Cloud:"
      echo "   TENCENTCLOUD_SECRET_ID"
      echo "   TENCENTCLOUD_SECRET_KEY"
      echo "   TENCENTCLOUD_REGION=ap-guangzhou"
      echo ""
      echo "After setting variables, run:"
      echo "  source ~/.bashrc"
      echo "  ./test-connectivity.sh"
      EOF
      chmod +x setup-clouds.sh
      
      # Create connectivity test
      cat > test-connectivity.sh << 'EOF'
      #!/bin/bash
      echo "=== Testing Cloud Connectivity ==="
      echo ""
      
      if [ -n "$AWS_ACCESS_KEY_ID" ]; then
        echo "Testing AWS..."
        aws sts get-caller-identity --output text --query 'Account' && echo "✅ AWS Connected" || echo "❌ AWS Connection Failed"
      else
        echo "⚠️ AWS not configured"
      fi
      
      if [ -n "$ALICLOUD_ACCESS_KEY" ]; then
        echo "Testing Alibaba Cloud..."
        aliyun configure list && echo "✅ Alibaba Cloud Connected" || echo "❌ Alibaba Cloud Connection Failed"
      else
        echo "⚠️ Alibaba Cloud not configured"
      fi
      
      if [ -n "$TENCENTCLOUD_SECRET_ID" ]; then
        echo "Testing Tencent Cloud..."
        python3 -c "from tencentcloud.common import credential; print('✅ Tencent Cloud SDK Available')" || echo "❌ Tencent Cloud Setup Issue"
      else
        echo "⚠️ Tencent Cloud not configured"
      fi
      
      echo ""
      echo "=== All Tests Complete ==="
      EOF
      chmod +x test-connectivity.sh
      
      echo "✅ Environment setup complete!"
      echo "Run './welcome.sh' to see available tools"
      
    command: |
      ./welcome.sh

vscode:
  extensions:
    - hashicorp.terraform
    - ms-kubernetes-tools.vscode-kubernetes-tools
    - ms-python.python

ports:
  - port: 3000
    onOpen: open-preview
  - port: 8080
    onOpen: open-preview
